import discord
from discord import app_commands
from discord.ext import commands
import aiohttp
import datetime
import json
import asyncio

# --- CONFIGURATION ---
TOKEN = "MTQyMTUyMDExNzU1NjA1MTk5OA.GlGThv.BNgvFgSJFerorVLTP1kgRNrKmvIMbewUF4Xwuc"
REQUIRED_ROLE_ID = 1426095150257672223  # User's Role ID

# --- THEME & DESIGN ---
class Theme:
    SUCCESS = discord.Color(0x57F287)
    ERROR = discord.Color(0xED4245)
    INFO = discord.Color(0x5865F2)
    WARNING = discord.Color(0xFEE75C)
    DARK = discord.Color(0x2B2D31)
    
    ICON_SUCCESS = "âœ…"
    ICON_ERROR = "âŒ"
    ICON_INFO = "â„¹ï¸"
    ICON_WARNING = "âš ï¸"
    ICON_USER = "ðŸ‘¤"
    ICON_KEY = "ðŸ”‘"
    ICON_DB = "ðŸ—„ï¸"
    ICON_TIME = "â³"

# Firebase URLs
URLS = {
    'premium': "https://botul-7b0b9-default-rtdb.firebaseio.com/",
    'bypass': "https://botulbypass-default-rtdb.firebaseio.com/"
}

# Setup Bot
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# --- HELPERS ---

def get_db_url(db_alias):
    db_alias = db_alias.lower()
    if db_alias in ['p', 'premium']:
        return URLS['premium'], "Premium"
    elif db_alias in ['b', 'bypass']:
        return URLS['bypass'], "Bypass"
    return None, None

async def firebase_request(method, url, data=None):
    async with aiohttp.ClientSession() as session:
        try:
            if method == "GET":
                async with session.get(url) as resp:
                    return await resp.json()
            elif method == "PUT":
                async with session.put(url, json=data) as resp:
                    return await resp.json()
            elif method == "PATCH":
                async with session.patch(url, json=data) as resp:
                    return await resp.json()
            elif method == "DELETE":
                async with session.delete(url) as resp:
                    return resp.status
        except Exception as e:
            print(f"Firebase Error: {e}")
            return None

def create_embed(title, description, color, fields=None, thumbnail=None):
    embed = discord.Embed(
        title=title, 
        description=description, 
        color=color,
        timestamp=datetime.datetime.now()
    )
    if fields:
        for name, value, inline in fields:
            embed.add_field(name=name, value=value, inline=inline)
    
    if thumbnail:
        embed.set_thumbnail(url=thumbnail)
        
    embed.set_footer(text="Shorif Admin Panel", icon_url="https://cdn.discordapp.com/embed/avatars/0.png")
    return embed

# --- CHECKS ---

def has_required_role():
    """Custom check to ensure user has the role (Double verification)."""
    async def predicate(interaction: discord.Interaction):
        if isinstance(interaction.user, discord.Member):
            role = interaction.guild.get_role(REQUIRED_ROLE_ID)
            if role and role in interaction.user.roles:
                return True

        raise app_commands.MissingRole(REQUIRED_ROLE_ID)
    return app_commands.check(predicate)

@bot.tree.error
async def on_app_command_error(interaction: discord.Interaction, error: app_commands.AppCommandError):
    if isinstance(error, (app_commands.MissingRole, app_commands.CheckFailure)):
        embed = create_embed(
            f"{Theme.ICON_ERROR} Access Denied", 
            f"You do not have permission to use this bot.\nYour role does not match the required ID.", 
            Theme.ERROR
        )
        if not interaction.response.is_done():
            await interaction.response.send_message(embed=embed, ephemeral=True)
    else:
        print(f"Error: {error}")

# --- SLASH COMMANDS ---

@bot.event
async def on_ready():
    try:
        synced = await bot.tree.sync()
        print(f"Success: Synced {len(synced)} commands.")
    except Exception as e:
        print(f"Failed to sync commands: {e}")
    
    print(f"Logged in as {bot.user}")
    await bot.change_presence(activity=discord.Activity(type=discord.ActivityType.watching, name="User Database"))

# Note: We set default_member_permissions to Administrator. 
# This HIDES the command from everyone else by default.
# The server admin must go to Server Settings > Integrations > Bot and ADD the Role to allow them to see it.

@bot.tree.command(name="add", description="Add a new user to the database.")
@app_commands.default_permissions(administrator=True)
@has_required_role()
@app_commands.choices(database=[
    app_commands.Choice(name="Premium", value="premium"),
    app_commands.Choice(name="Bypass", value="bypass")
])
@app_commands.describe(username="Username", password="Password", days="Days valid")
async def add_user(interaction: discord.Interaction, database: app_commands.Choice[str], username: str, password: str, days: int):
    await interaction.response.defer()
    
    base_url, db_name = get_db_url(database.value)
    
    user_url = f"{base_url}{username}.json"
    existing = await firebase_request("GET", user_url)
    if existing:
        embed = create_embed(f"{Theme.ICON_WARNING} User Exists", f"User **`{username}`** already exists in **{db_name}**.", Theme.WARNING)
        await interaction.followup.send(embed=embed, ephemeral=True)
        return

    expiry = (datetime.datetime.now() + datetime.timedelta(days=days)).strftime("%Y-%m-%d")

    data = {
        "username": username,
        "password": password,
        "hwid": "",
        "expiry": expiry,
        "status": "active",
        "subscription": "active",
        "ban_reason": ""
    }

    await firebase_request("PUT", user_url, data)
    
    fields = [
        (f"{Theme.ICON_USER} Username", f"`{username}`", True),
        (f"{Theme.ICON_KEY} Password", f"`{password}`", True),
        (f"{Theme.ICON_TIME} Expiry", f"`{expiry}`", True),
        (f"{Theme.ICON_DB} Database", f"**{db_name}**", True)
    ]
    
    embed = create_embed(f"{Theme.ICON_SUCCESS} User Created", "User successfully added.", Theme.SUCCESS, fields)
    await interaction.followup.send(embed=embed)

@bot.tree.command(name="del", description="Delete a user.")
@app_commands.default_permissions(administrator=True)
@has_required_role()
@app_commands.choices(database=[
    app_commands.Choice(name="Premium", value="premium"),
    app_commands.Choice(name="Bypass", value="bypass")
])
async def delete_user(interaction: discord.Interaction, database: app_commands.Choice[str], username: str):
    await interaction.response.defer()
    base_url, db_name = get_db_url(database.value)

    user_url = f"{base_url}{username}.json"
    existing = await firebase_request("GET", user_url)
    if not existing:
        embed = create_embed(f"{Theme.ICON_ERROR} Not Found", f"User **`{username}`** not found.", Theme.ERROR)
        await interaction.followup.send(embed=embed, ephemeral=True)
        return

    await firebase_request("DELETE", user_url)
    embed = create_embed(f"{Theme.ICON_SUCCESS} Deleted", f"User **`{username}`** deleted.", Theme.SUCCESS)
    await interaction.followup.send(embed=embed)

@bot.tree.command(name="info", description="Get user info.")
@app_commands.default_permissions(administrator=True)
@has_required_role()
@app_commands.choices(database=[
    app_commands.Choice(name="Premium", value="premium"),
    app_commands.Choice(name="Bypass", value="bypass")
])
async def user_info(interaction: discord.Interaction, database: app_commands.Choice[str], username: str):
    await interaction.response.defer()
    base_url, db_name = get_db_url(database.value)

    user_url = f"{base_url}{username}.json"
    data = await firebase_request("GET", user_url)
    
    if not data:
        embed = create_embed(f"{Theme.ICON_ERROR} Not Found", f"User **`{username}`** not found.", Theme.ERROR)
        await interaction.followup.send(embed=embed, ephemeral=True)
        return

    status = data.get("status", "unknown").upper()
    color = Theme.INFO
    status_icon = "ðŸŸ¢"
    if status == "INACTIVE":
        color = Theme.ERROR
        status_icon = "ðŸ”´"
    
    fields = [
        ("Username", f"`{username}`", True),
        ("Password", f"||`{data.get('password', 'N/A')}`||", True),
        ("Status", f"{status_icon} **{status}**", True),
        ("Expiry", f"`{data.get('expiry', 'N/A')}`", True),
        ("Database", f"**{db_name}**", True),
        ("HWID", f"```yaml\n{data.get('hwid') or 'Not Set'}\n```", False)
    ]
    
    embed = create_embed(f"{Theme.ICON_USER} User Profile", f"Details for **{username}**", color, fields)
    await interaction.followup.send(embed=embed)

@bot.tree.command(name="reset", description="Reset HWID.")
@app_commands.default_permissions(administrator=True)
@has_required_role()
@app_commands.choices(database=[
    app_commands.Choice(name="Premium", value="premium"),
    app_commands.Choice(name="Bypass", value="bypass")
])
async def reset_hwid(interaction: discord.Interaction, database: app_commands.Choice[str], username: str):
    await interaction.response.defer()
    base_url, db_name = get_db_url(database.value)

    user_url = f"{base_url}{username}.json"
    existing = await firebase_request("GET", user_url)
    if not existing:
        embed = create_embed(f"{Theme.ICON_ERROR} Not Found", f"User **`{username}`** not found.", Theme.ERROR)
        await interaction.followup.send(embed=embed, ephemeral=True)
        return

    await firebase_request("PATCH", user_url, {"hwid": ""})
    embed = create_embed(f"{Theme.ICON_SUCCESS} HWID Reset", f"HWID for **`{username}`** reset.", Theme.SUCCESS)
    await interaction.followup.send(embed=embed)

@bot.tree.command(name="ban", description="Ban a user.")
@app_commands.default_permissions(administrator=True)
@has_required_role()
@app_commands.choices(database=[
    app_commands.Choice(name="Premium", value="premium"),
    app_commands.Choice(name="Bypass", value="bypass")
])
async def ban_user(interaction: discord.Interaction, database: app_commands.Choice[str], username: str, reason: str = "Banned by Admin"):
    await interaction.response.defer()
    base_url, db_name = get_db_url(database.value)

    user_url = f"{base_url}{username}.json"
    existing = await firebase_request("GET", user_url)
    if not existing:
        embed = create_embed(f"{Theme.ICON_ERROR} Not Found", f"User **`{username}`** not found.", Theme.ERROR)
        await interaction.followup.send(embed=embed, ephemeral=True)
        return

    await firebase_request("PATCH", user_url, {"status": "inactive", "subscription": "inactive", "ban_reason": reason})
    embed = create_embed(f"ðŸš« User Banned", f"**`{username}`** banned.\nReason: {reason}", Theme.ERROR)
    await interaction.followup.send(embed=embed)

@bot.tree.command(name="unban", description="Unban a user.")
@app_commands.default_permissions(administrator=True)
@has_required_role()
@app_commands.choices(database=[
    app_commands.Choice(name="Premium", value="premium"),
    app_commands.Choice(name="Bypass", value="bypass")
])
async def unban_user(interaction: discord.Interaction, database: app_commands.Choice[str], username: str):
    await interaction.response.defer()
    base_url, db_name = get_db_url(database.value)

    user_url = f"{base_url}{username}.json"
    existing = await firebase_request("GET", user_url)
    if not existing:
        embed = create_embed(f"{Theme.ICON_ERROR} Not Found", f"User **`{username}`** not found.", Theme.ERROR)
        await interaction.followup.send(embed=embed, ephemeral=True)
        return

    await firebase_request("PATCH", user_url, {"status": "active", "subscription": "active", "ban_reason": ""})
    embed = create_embed(f"{Theme.ICON_SUCCESS} User Unbanned", f"**`{username}`** unbanned.", Theme.SUCCESS)
    await interaction.followup.send(embed=embed)

@bot.tree.command(name="list", description="List users.")
@app_commands.default_permissions(administrator=True)
@has_required_role()
@app_commands.choices(database=[
    app_commands.Choice(name="Premium", value="premium"),
    app_commands.Choice(name="Bypass", value="bypass")
])
async def list_users(interaction: discord.Interaction, database: app_commands.Choice[str], search: str = None):
    await interaction.response.defer()
    base_url, db_name = get_db_url(database.value)

    data = await firebase_request("GET", base_url + ".json")
    if not data:
        embed = create_embed(f"{Theme.ICON_WARNING} Empty", "No users found.", Theme.WARNING)
        await interaction.followup.send(embed=embed)
        return

    users = []
    if isinstance(data, list):
        for item in data:
            if item: users.append(item)
    else:
        for key, val in data.items():
            val['username'] = key
            users.append(val)

    if search:
        users = [u for u in users if search.lower() in u.get('username', '').lower()]

    if not users:
        embed = create_embed("ðŸ” No Matches", f"No users found matching **`{search}`**.", Theme.WARNING)
        await interaction.followup.send(embed=embed)
        return

    desc_lines = []
    for i, u in enumerate(users[:20], 1):
        name = u.get('username', 'Unknown')
        status = u.get('status', 'active').lower()
        icon = "ðŸŸ¢" if status == 'active' else "ðŸ”´"
        style = f"**`{name}`**" if status == 'active' else f"~~`{name}`~~"
        desc_lines.append(f"`{i:02d}.` {icon} {style}")

    total = len(users)
    desc = "\n".join(desc_lines)
    if total > 20: desc += f"\n...and {total - 20} more users."

    embed = create_embed(f"{Theme.ICON_DB} User List ({total})", desc, Theme.INFO)
    await interaction.followup.send(embed=embed)

if __name__ == "__main__":
    bot.run(TOKEN)
